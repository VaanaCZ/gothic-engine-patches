// AI fixes for Union
// created by Auronen, Fawkes and Vaana

#engine [G1]
    #patch [Fixed SVM interrupt on certain perceptions]Â´
        BOOL g_bDontInterruptSound = False
        
        #assembler [0x006A803E]
            mov     dword ptr ds:[$g_bDontInterruptSound], 1
            orgcode
            mov     dword ptr ds:[$g_bDontInterruptSound], 0
        #/assembler
        
        #assembler [0x00692A5D]
            mov     eax, dword ptr ds:[$g_bDontInterruptSound]
            test    eax, eax
            jnz     0x00692B1B
            orgcode
        #/assembler
        
        #assembler [0x006DDFB3]
            ; Check is message is oCMsgConversation::EV_OUTPUTSVM_OVERLAY
            cmp     dword ptr [esi], 0x007DE5CC ; oCMsgConversation vftable
            jne     deleteAsUsual
            mov     ax, [esi+24h]               ; subType
            cmp     ax, 12h                     ; EV_OUTPUTSVM_OVERLAY
            jne     deleteAsUsual
            
            ; If we are in EV_DoState, skip deletion
            ; Otherwise, stop the SVM module
            mov     eax, dword ptr ds:[$g_bDontInterruptSound]
            test    eax, eax
            jz      libSvmModuleStop
            
            ; Skip deletion
            jmp     0x006DDFD1
            
            ; Call LibSvmModuleStop
        libSvmModuleStop:
            mov     ecx, ds:[0x008DA6BC]        ; oCGame* ogame
            mov     eax, [ecx]
            call    dword ptr [eax+40h]
            mov     ecx, [esi+8Ch]              ; number
            mov     edx, [eax]
            push    ecx
            mov     ecx, eax
            call    dword ptr [edx+64h]
            
        deleteAsUsual:
            orgcode
        #/assembler
        
//        #assembler [0x006C33BC]
//            ; Call LibSvmModuleStop
//            mov     ecx, ds:[0x008DA6BC]        ; oCGame* ogame
//            mov     eax, [ecx]
//            call    dword ptr [eax+40h]
//            mov     ecx, [esi+8Ch]              ; number
//            mov     edx, [eax]
//            push    ecx
//            mov     ecx, eax
//            call    dword ptr [edx+64h]
//
//            orgcode
//        #/assembler
    #/patch
#/engine
